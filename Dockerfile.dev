# Copyright 2020 The DataWorkbench Authors. All rights reserved.
# Use of this source code is governed by a Apache license
# that can be found in the LICENSE file.
FROM dataworkbench/builder as builder

ARG DATABENCH_CONF=/etc/dataworkbench
RUN mkdir -p ${DATABENCH_CONF}

ARG SERVICE
COPY ./deploy/tmp/conf/${SERVICE}.yaml ${DATABENCH_CONF}/
COPY ./deploy/tmp/bin/${SERVICE} /usr/local/bin/
RUN upx /usr/local/bin/${SERVICE}


###############################################################
FROM alpine:3.12

RUN apk add -U tzdata && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

ENV DATABENCH_CONF=/etc/dataworkbench
RUN mkdir -p ${DATABENCH_CONF}

ARG SERVICE
COPY --from=builder /usr/local/bin/grpc_health_probe /usr/local/bin/
COPY --from=builder ${DATABENCH_CONF}/${SERVICE}.yaml ${DATABENCH_CONF}/
COPY --from=builder /usr/local/bin/${SERVICE} /usr/local/bin/

CMD ["sh"]
