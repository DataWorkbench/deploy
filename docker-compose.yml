# Copyright 2020 The Databench Authors. All rights reserved.
# Use of this source code is governed by a Apache license
# that can be found in the LICENSE file.

version: '3'

networks:
  databench-net:

services:
  databench-db:
    container_name: "databench-db"
    image: "mysql:8.0.11"
    command: --default-authentication-plugin=mysql_native_password
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
#      - MYSQL_USER=${MYSQL_USER} # there is no need to set root that created by default with the password specified by MYSQL_PASSWORD
#      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - ${LOCAL_VOLUME_PATH}/mysql:/var/lib/mysql
    ports:
      - "3306:${MYSQL_PORT}" # for test & debug
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - databench-db

  databench-db-init:
    container_name: "databench-db-init"
    image: ${IMAGE_REPO}/flyway:${IMAGE_TAG}
    entrypoint: "sh"
    command: -c "/flyway/sql/ddl/ddl_init.sh --connect-timeout=5"
    environment:
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_PORT=${MYSQL_PORT}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db
    networks:
      databench-net:
        aliases:
          - databench-db-init

  databench-db-ctrl:
    image: ${IMAGE_REPO}/flyway:${IMAGE_TAG}
    container_name: "databench-db-ctrl"
    command: -url=jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DATABASE} -user=${MYSQL_USER} -password=${MYSQL_PASSWORD} -validateOnMigrate=false migrate
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-init
    networks:
      databench-net:
        aliases:
          - databench-ctrl

  databench-etcd:
    image: "quay.io/coreos/etcd:latest"
    container_name: "databench-etcd"
    volumes:
      - ${LOCAL_VOLUME_PATH}/etcd:/etcd-data
    command: "/usr/local/bin/etcd --data-dir=/etcd-data --name databench-etcd --initial-advertise-peer-urls http://0.0.0.0:2380 --listen-peer-urls http://0.0.0.0:2380 --advertise-client-urls http://0.0.0.0:2379 --listen-client-urls http://0.0.0.0:2379 --initial-cluster databench-etcd=http://0.0.0.0:2380"
    ports:
      - "2379:${ETCD_SERVER_PORT}" # for test & debug
      - "2380:${ETCD_PEER_PORT}" # for test & debug
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - databench-etcd

  databench-jaeger:
    image: "jaegertracing/all-in-one:1.22"
    container_name: "databench-jaeger"
    ports:
      - "5775:5775/udp" # for test & debug
      - "6831:6831/udp" # for test & debug
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14268:14268"
      - "14250:14250"
      - "9411:9411"
    environment:
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - databench-jaeger

  apiglobal:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-apiglobal"
    command: "apiglobal start -c ${DATABENCH_CONF}/apiglobal.yaml"
    ports:
      - "${API_GLOBAL_PORT}:${API_GLOBAL_PORT}"
    links:
      - apiserver
      - account
    depends_on:
      - apiserver
      - databench-jaeger
      - account
    environment:
      - API_GLOBAL_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - API_GLOBAL_READ_TIMEOUT=${API_SERVER_READ_TIMEOUT}
      - API_GLOBAL_WRITE_TIMEOUT=${API_SERVER_WRITE_TIMEOUT}
      - API_GLOBAL_DLE_TIMEOUT=${API_SERVER_DLE_TIMEOUT}
      - API_GLOBAL_EXIT_TIMEOUT=${API_SERVER_EXIT_TIMEOUT}
      - API_GLOBAL_HTTP_SERVER_ADDRESS=0.0.0.0:${API_GLOBAL_PORT}
      - API_GLOBAL_TRACER_SERVICE_NAME=apiglobal
      - API_GLOBAL_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
      - API_GLOBAL_REGIONS=staging:http://apiserver:9001|zh_cn:开发测试区,en_us:staging mock:http://apiserver:9001|zh_cn:模拟测试用,en_us:mock
      - API_GLOBAL_ACCOUNT_SERVER_ADDRESS=account:${ACCOUNT_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - apiglobal

  apiserver:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-apiserver"
    command: "apiserver start -c ${DATABENCH_CONF}/apiserver.yaml"
    ports:
      - "${API_SERVER_PORT}:${API_SERVER_PORT}"
    links:
      - spacemanager
      - flowmanager
      - scheduler
      - sourcemanager
      - jobmanager
      - udfmanager
      - resourcemanager
      - account
      - enginemanager
    depends_on:
      - spacemanager
      - flowmanager
      - scheduler
      - sourcemanager
      - jobmanager
      - udfmanager
      - databench-jaeger
      - account
      - enginemanager
    environment:
      - API_SERVER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - API_SERVER_READ_TIMEOUT=${API_SERVER_READ_TIMEOUT}
      - API_SERVER_WRITE_TIMEOUT=${API_SERVER_WRITE_TIMEOUT}
      - API_SERVER_DLE_TIMEOUT=${API_SERVER_DLE_TIMEOUT}
      - API_SERVER_EXIT_TIMEOUT=${API_SERVER_EXIT_TIMEOUT}
      - API_SERVER_HTTP_SERVER_ADDRESS=0.0.0.0:${API_SERVER_PORT}
      - API_SERVER_TRACER_SERVICE_NAME=apiserver
      - API_SERVER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
      - API_SERVER_SPACE_MANAGER_ADDRESS=spacemanager:${SPACE_MANAGER_PORT}
      - API_SERVER_SPACE_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_SPACE_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_FLOW_MANAGER_ADDRESS=flowmanager:${FLOW_MANAGER_PORT}
      - API_SERVER_FLOW_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_FLOW_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_SCHEDULER_ADDRESS=scheduler:${SCHEDULER_PORT}
      - API_SERVER_SCHEDULER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_SCHEDULER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_SOURCE_MANAGER_ADDRESS=sourcemanager:${SOURCE_MANAGER_PORT}
      - API_SERVER_SOURCE_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_SOURCE_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_JOB_MANAGER_ADDRESS=jobmanager:${JOB_MANAGER_PORT}
      - API_SERVER_JOB_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_JOB_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_UDF_MANAGER_ADDRESS=udfmanager:${UDF_MANAGER_PORT}
      - API_SERVER_UDF_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_UDF_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_OBSERVER_MANAGER_ADDRESS=observer:{OBSERVER_PORT}
      - API_SERVER_OBSERVER_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_OBSERVER_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_RESOURCE_MANAGER_ADDRESS=resourcemanager:${RESOURCE_MANAGER_PORT}
      - API_SERVER_RESOURCE_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_RESOURCE_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_ACCOUNT_SERVER_ADDRESS=account:${ACCOUNT_PORT}
      - API_SERVER_ACCOUNT_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_ACCOUNT_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - API_SERVER_ENGINE_MANAGER_ADDRESS=enginemanager:${ENGINE_MANAGER_PORT}
      - API_SERVER_ENGINE_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - API_SERVER_ENGINE_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - apiserver

  spacemanager:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-spacemanager"
    command: "spacemanager start -c ${DATABENCH_CONF}/spacemanager.yaml"
    ports:
      - "${SPACE_MANAGER_PORT}:${SPACE_MANAGER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
      - databench-jaeger
    environment:
      - SPACE_MANAGER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - SPACE_MANAGER_GRPC_SERVER_ADDRESS=0.0.0.0:${SPACE_MANAGER_PORT}
      - SPACE_MANAGER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - SPACE_MANAGER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - SPACE_MANAGER_METRICS_ENABLED=${METRICS_ENABLED}
      - SPACE_MANAGER_METRICS_SERVER_ADDRESS=0.0.0.0:${SPACE_MANAGER_METRICS_PORT}
      - SPACE_MANAGER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - SPACE_MANAGER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - SPACE_MANAGER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - SPACE_MANAGER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - SPACE_MANAGER_TRACER_SERVICE_NAME=spacemanager
      - SPACE_MANAGER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - spacemanager

  flowmanager:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-flowmanager"
    command: "flowmanager start -c ${DATABENCH_CONF}/flowmanager.yaml"
    ports:
      - "${FLOW_MANAGER_PORT}:${FLOW_MANAGER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
      - databench-etcd
      - databench-jaeger
    environment:
      - FLOW_MANAGER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - FLOW_MANAGER_GRPC_SERVER_ADDRESS=0.0.0.0:${FLOW_MANAGER_PORT}
      - FLOW_MANAGER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - FLOW_MANAGER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - FLOW_MANAGER_METRICS_ENABLED=${METRICS_ENABLED}
      - FLOW_MANAGER_METRICS_SERVER_ADDRESS=0.0.0.0:${FLOW_MANAGER_METRICS_PORT}
      - FLOW_MANAGER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - FLOW_MANAGER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - FLOW_MANAGER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - FLOW_MANAGER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - FLOW_MANAGER_SCHEDULER_ADDRESS=scheduler:${SCHEDULER_PORT}
      - FLOW_MANAGER_SCHEDULER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - FLOW_MANAGER_SCHEDULER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - FLOW_MANAGER_TRACER_SERVICE_NAME=flowmanager
      - FLOW_MANAGER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - flowmanager

  scheduler:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-scheduler"
    command: "scheduler start -c ${DATABENCH_CONF}/scheduler.yaml"
    ports:
      - "${SCHEDULER_PORT}:${SCHEDULER_PORT}"
    links:
      - databench-db:databench-db
      - databench-etcd:databench-etcd
    depends_on:
      - databench-db-ctrl
      - databench-etcd
      - databench-jaeger
    environment:
      - SCHEDULER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - SCHEDULER_GRPC_SERVER_ADDRESS=0.0.0.0:${SCHEDULER_PORT}
      - SCHEDULER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - SCHEDULER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - SCHEDULER_METRICS_ENABLED=${METRICS_ENABLED}
      - SCHEDULER_METRICS_SERVER_ADDRESS=0.0.0.0:${SCHEDULER_METRICS_PORT}
      - SCHEDULER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - SCHEDULER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - SCHEDULER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - SCHEDULER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - SCHEDULER_ETCD_ENDPOINTS=databench-etcd:${ETCD_SERVER_PORT}
      - SCHEDULER_ETCD_DIAL_TIMEOUT=5s
      - SCHEDULER_TRACER_SERVICE_NAME=scheduler
      - SCHEDULER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
      - SCHEDULER_FLOW_MANAGER_ADDRESS=flowmanager:${FLOW_MANAGER_PORT}
      - SCHEDULER_FLOW_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - SCHEDULER_FLOW_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - SCHEDULER_JOB_MANAGER_ADDRESS=jobmanager:${JOB_MANAGER_PORT}
      - SCHEDULER_JOB_MANAGER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - SCHEDULER_JOB_MANAGER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - scheduler

  sourcemanager:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-sourcemanager"
    command: "sourcemanager start -c ${DATABENCH_CONF}/sourcemanager.yaml"
    ports:
      - "${SOURCE_MANAGER_PORT}:${SOURCE_MANAGER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
      - databench-jaeger
    environment:
      - SOURCE_MANAGER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - SOURCE_MANAGER_GRPC_SERVER_ADDRESS=0.0.0.0:${SOURCE_MANAGER_PORT}
      - SOURCE_MANAGER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - SOURCE_MANAGER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - SOURCE_MANAGER_METRICS_ENABLED=${METRICS_ENABLED}
      - SOURCE_MANAGER_METRICS_SERVER_ADDRESS=0.0.0.0:${SOURCE_MANAGER_METRICS_PORT}
      - SOURCE_MANAGER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - SOURCE_MANAGER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - SOURCE_MANAGER_MYSQL_USERS=${MYSQL_USER}
      - SOURCE_MANAGER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - SOURCE_MANAGER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - SOURCE_MANAGER_TRACER_SERVICE_NAME=sourcemanager
      - SOURCE_MANAGER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - sourcemanager

  udfmanager:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-udfmanager"
    command: "udfmanager start -c ${DATABENCH_CONF}/udfmanager.yaml"
    ports:
      - "${UDF_MANAGER_PORT}:${UDF_MANAGER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
    environment:
      - UDF_MANAGER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - UDF_MANAGER_GRPC_SERVER_ADDRESS=0.0.0.0:${UDF_MANAGER_PORT}
      - UDF_MANAGER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - UDF_MANAGER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - UDF_MANAGER_METRICS_ENABLED=${METRICS_ENABLED}
      - UDF_MANAGER_METRICS_SERVER_ADDRESS=0.0.0.0:${UDF_MANAGER_METRICS_PORT}
      - UDF_MANAGER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - UDF_MANAGER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - UDF_MANAGER_MYSQL_USERS=${MYSQL_USER}
      - UDF_MANAGER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - UDF_MANAGER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - UDF_MANAGER_TRACER_SERVICE_NAME=udfmanager
      - UDF_MANAGER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - udfmanager

  zeppelinscale:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-zeppelinscale"
    command: "zeppelinscale start -c ${DATABENCH_CONF}/zeppelinscale.yaml"
    ports:
      - "${ZEPPELIN_SCALE_PORT}:${ZEPPELIN_SCALE_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
    environment:
      - ZEPPELIN_SCALE_ZEPPELIN_SERVER_ADDRESS=zeppelin:8080
      - ZEPPELIN_SCALE_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - ZEPPELIN_SCALE_GRPC_SERVER_ADDRESS=0.0.0.0:${ZEPPELIN_SCALE_PORT}
      - ZEPPELIN_SCALE_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - ZEPPELIN_SCALE_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - ZEPPELIN_SCALE_METRICS_ENABLED=${METRICS_ENABLED}
      - ZEPPELIN_SCALE_METRICS_SERVER_ADDRESS=0.0.0.0:${ZEPPELIN_SCALE_METRICS_PORT}
      - ZEPPELIN_SCALE_TRACER_SERVICE_NAME=zeppelinscale
      - ZEPPELIN_SCALE_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - zeppelinscale

  jobwatcher:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-jobwatcher"
    command: "jobwatcher start -c ${DATABENCH_CONF}/jobwatcher.yaml"
    ports:
      - "${JOB_WATCHER_PORT}:${JOB_WATCHER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
    environment:
      - JOB_WATCHER_JOB_WORKS=16
      - JOB_WATCHER_JOBDEVELOPER_SERVER_ADDRESS=jobdeveloper:${JOB_DEVELOPER_PORT}
      - JOB_WATCHER_PICKUP_ALONE_JOBS=1
      - JOB_WATCHER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - JOB_WATCHER_GRPC_SERVER_ADDRESS=0.0.0.0:${JOB_WATCHER_PORT}
      - JOB_WATCHER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - JOB_WATCHER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - JOB_WATCHER_METRICS_ENABLED=${METRICS_ENABLED}
      - JOB_WATCHER_METRICS_SERVER_ADDRESS=0.0.0.0:${JOB_WATCHER_METRICS_PORT}
      - JOB_WATCHER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - JOB_WATCHER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - JOB_WATCHER_MYSQL_USERS=${MYSQL_USER}
      - JOB_WATCHER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - JOB_WATCHER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - JOB_WATCHER_TRACER_SERVICE_NAME=jobwatcher
      - JOB_WATCHER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - jobwatcher

  jobdeveloper:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-jobdeveloper"
    command: "jobdeveloper start -c ${DATABENCH_CONF}/jobdeveloper.yaml"
    ports:
      - "${JOB_DEVELOPER_PORT}:${JOB_DEVELOPER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
    environment:
      - JOB_DEVELOPER_ZEPPELIN_FLINK_HOME=/zeppelin/flink/flink-1.12.3
      - JOB_DEVELOPER_ZEPPELIN_HADOOP_CONF=/zeppelin/hadoop/hadoop-2.7.5/etc/hadoop
      - JOB_DEVELOPER_ZEPPELIN_FLINK_EXECUTE_JARS=MySQL:/zeppelin/flink/1.12_lib/flink-connector-jdbc_2.11-1.12.3.jar,/zeppelin/flink/1.12_lib/mysql-connector-java-8.0.21.jar;PostgreSQL:/zeppelin/flink/1.12_lib/flink-connector-jdbc_2.11-1.12.3.jar,/zeppelin/flink/1.12_lib/postgresql-42.2.18.jar;Kafka:/zeppelin/flink/1.12_lib/flink-sql-connector-kafka_2.11-1.12.3.jar;ClickHouse:/zeppelin/flink/1.12_lib/flink-connector-jdbc_2.11-1.12.3.jar,/zeppelin/flink/1.12_lib/flink-connector-clickhouse-1.0.0.jar;HBase:/zeppelin/flink/1.12_lib/flink-shaded-hadoop-2-uber-2.8.3-10.0.jar,/zeppelin/flink/1.12_lib/flink-sql-connector-hbase-2.2_2.11-1.12.3.jar;Ftp:/zeppelin/flink/1.12_lib/flink-connector-ftp_2.11_1.12.0.jar,/zeppelin/flink/1.12_lib/flink-csv-1.12.2.jar,/zeppelin/flink/1.12_lib/flink-json-1.12.2.jar
      - JOB_DEVELOPER_UDFMANAGER_SERVER_ADDRESS=udfmanager:${UDF_MANAGER_PORT}
      - JOB_DEVELOPER_SOURCEMANAGER_SERVER_ADDRESS=sourcemanager:${SOURCE_MANAGER_PORT}
      - JOB_DEVELOPER_RESOURCEMANAGER_SERVER_ADDRESS=resourcemanager:${RESOURCE_MANAGER_PORT}
      - JOB_DEVELOPER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - JOB_DEVELOPER_GRPC_SERVER_ADDRESS=0.0.0.0:${JOB_DEVELOPER_PORT}
      - JOB_DEVELOPER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - JOB_DEVELOPER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - JOB_DEVELOPER_METRICS_ENABLED=${METRICS_ENABLED}
      - JOB_DEVELOPER_METRICS_SERVER_ADDRESS=0.0.0.0:${JOB_WATCHER_METRICS_PORT}
      - JOB_DEVELOPER_TRACER_SERVICE_NAME=jobdeveloper
      - JOB_DEVELOPER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - jobdeveloper

  jobmanager:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-jobmanager"
    command: "jobmanager start -c ${DATABENCH_CONF}/jobmanager.yaml"
    ports:
      - "${JOB_MANAGER_PORT}:${JOB_MANAGER_PORT}"
    links:
      - databench-db:databench-db
      - jobwatcher:jobwatcher
      - jobdeveloper:jobdeveloper
      - zeppelinscale:zeppelinscale
    depends_on:
      - databench-db-ctrl
      - databench-jaeger
    environment:
      - JOB_MANAGER_ZEPPELIN_SCALE_SERVER_ADDRESS=zeppelinscale:${ZEPPELIN_SCALE_PORT}
      - JOB_MANAGER_JOBDEVELOPER_SERVER_ADDRESS=jobdeveloper:${JOB_DEVELOPER_PORT}
      - JOB_MANAGER_JOBWATCHER_SERVER_ADDRESS=jobwatcher:${JOB_WATCHER_PORT}
      - JOB_MANAGER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - JOB_MANAGER_GRPC_SERVER_ADDRESS=0.0.0.0:${JOB_MANAGER_PORT}
      - JOB_MANAGER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - JOB_MANAGER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - JOB_MANAGER_METRICS_ENABLED=${METRICS_ENABLED}
      - JOB_MANAGER_METRICS_SERVER_ADDRESS=0.0.0.0:${JOB_MANAGER_METRICS_PORT}
      - JOB_MANAGER_MYSQL_HOSTS=${MYSQL_HOST}:${MYSQL_PORT}
      - JOB_MANAGER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - JOB_MANAGER_MYSQL_USERS=${MYSQL_USER}
      - JOB_MANAGER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - JOB_MANAGER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - JOB_MANAGER_TRACER_SERVICE_NAME=jobmanager
      - JOB_MANAGER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - jobmanager

  resourcemanager:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-resourcemanager"
    command: "resourcemanager start -c ${DATABENCH_CONF}/resourcemanager.yaml"
    ports:
      - "${RESOURCE_MANAGER_PORT}:${RESOURCE_MANAGER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
    environment:
      - RESOURCE_MANAGER_HDFS_SERVER=hadoop:9000
      - RESOURCE_MANAGER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - RESOURCE_MANAGER_GRPC_SERVER_ADDRESS=0.0.0.0:${RESOURCE_MANAGER_PORT}
      - RESOURCE_MANAGER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - RESOURCE_MANAGER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - RESOURCE_MANAGER_METRICS_ENABLED=${METRICS_ENABLED}
      - RESOURCE_MANAGER_METRICS_SERVER_ADDRESS=0.0.0.0:${RESOURCE_MANAGER_METRICS_PORT}
      - RESOURCE_MANAGER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - RESOURCE_MANAGER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - RESOURCE_MANAGER_MYSQL_USERS=${MYSQL_USER}
      - RESOURCE_MANAGER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - RESOURCE_MANAGER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - RESOURCE_MANAGER_TRACER_SERVICE_NAME=resourcemanager
      - RESOURCE_MANAGER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - resourcemanager

  zeppelin:
    image: ${IMAGE_REPO}/zeppelin:${ZEPPELIN_IMAGE_TAG}
    container_name: "databench-zeppelin"
    links:
      - flinkjobmanager:flinkjobmanager
    ports:
      - "${ZEPPELIN_NODEPORT}:8080"
    depends_on:
      - flinkjobmanager
      - flinktaskmanager
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - zeppelin

  flinkjobmanager:
    container_name: "databench-flink-jobmanager"
    #image: "flink:1.12.3-scala_2.11"
    image: ${IMAGE_REPO}/flinkutile:${FLINK_IMAGE_TAG}
    links:
      - databench-db:databench-db
    ports:
      - "${FLINK_PORT}:${FLINK_PORT}"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flinkjobmanager
    networks:
      databench-net:
        aliases:
          - flinkjobmanager

  flinktaskmanager:
    container_name: "databench-flink-taskmanager"
    #image: "flink:1.12.3-scala_2.11"
    image: ${IMAGE_REPO}/flinkutile:${FLINK_IMAGE_TAG}
    links:
      - databench-db:databench-db
    depends_on:
      - flinkjobmanager
    command: taskmanager
    scale: 1
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flinkjobmanager
        taskmanager.numberOfTaskSlots: 10
    networks:
      databench-net:
        aliases:
          - flinktaskmanager

  zookeeper:
    image: wurstmeister/zookeeper
    container_name: "databench-zookeeper"
    ports:
      - "2181:2181"
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - zookeeper

  databench-kafka-for-test:
    image: wurstmeister/kafka:2.12-2.5.0
    container_name: "databench-kafka-for-test"
    ports:
      - "9092:9092"
    links:
      - zookeeper:zookeeper
    environment:
      KAFKA_ADVERTISED_HOST_NAME: "databench-kafka-for-test"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - databench-kafka-for-test

  notifier:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-notifier"
    command: "notifier start -c ${DATABENCH_CONF}/notifier.yaml"
    ports:
      - "${NOTIFIER_PORT}:${NOTIFIER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
    environment:
      - NOTIFIER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - NOTIFIER_GRPC_SERVER_ADDRESS=0.0.0.0:${NOTIFIER_PORT}
      - NOTIFIER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - NOTIFIER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - NOTIFIER_METRICS_ENABLED=${METRICS_ENABLED}
      - NOTIFIER_METRICS_SERVER_ADDRESS=0.0.0.0:${NOTIFIER_METRICS_PORT}
      - NOTIFIER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - NOTIFIER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - NOTIFIER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - NOTIFIER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - notifier

  clickhouse:
    image: "yandex/clickhouse-server:latest"
    container_name: "dataworkbench-clickhouse-for-test"
    ports:
      - "8123:8123"
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      dataworkbench-net:
        aliases:
          - clickhouse

  postgres:
    image: "postgres:12.1"
    container_name: "dataworkbench-postgres-for-test"
    environment:
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      dataworkbench-net:
        aliases:
          - postgres

  hbase:
    image: "harisekhon/hbase:2.1"
    container_name: "databench-hbase-for-test"
    ports:
      - "2182:2181"
      # - "8080:8080"
      - "8085:8085"
      - "9090:9090"
      - "9095:9095"
      - "16000:16000"
      - "16010:16010"
      - "16201:16201"
      - "16301:16301"
      - "16030:16030"
      - "16020:16020"
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - hbase

  hadoop:
    image: "sequenceiq/hadoop-docker:2.7.0"
    container_name: "databench-hadoop-for-test"
    ports:
      - "50070:50070"
      - "9000:9000"
      - "8088:8088"
      - "8040:8040"
      - "8020:8020"
      - "8042:8042"
      - "49707:49707"
      - "50010:50010"
      - "50075:50075"
      - "50090:50090"
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - hadoop


  observer:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-observer"
    command: "observer start -c ${DATABENCH_CONF}/observer.yaml"
    ports:
      - "${OBSERVER_PORT}:${OBSERVER_PORT}"
    links:
      - databench-db:databench-db
    depends_on:
      - databench-db-ctrl
    environment:
      - OBSERVER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - OBSERVER_GRPC_SERVER_ADDRESS=0.0.0.0:${OBSERVER_PORT}
      - OBSERVER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - OBSERVER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - OBSERVER_METRICS_ENABLED=${METRICS_ENABLED}
      - OBSERVER_METRICS_SERVER_ADDRESS=0.0.0.0:${OBSERVER_METRICS_PORT}
      - OBSERVER_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - OBSERVER_MYSQL_DATABASE=${MYSQL_DATABASE}
      - OBSERVER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - OBSERVER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - observer

  databench-redis:
    image: "redis:5.0.0"
    container_name: "databench-redis"
    volumes:
      - ${LOCAL_VOLUME_PATH}/redis:/var/lib/redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:${REDIS_PORT}" # for test & debug
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - databench-redis

  account:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-account"
    command: "account start -c ${DATABENCH_CONF}/account.yaml"
    ports:
      - "${ACCOUNT_PORT}:${ACCOUNT_PORT}"
    links:
      - databench-db:databench-db
      - databench-redis:databench-redis
    depends_on:
      - databench-db-ctrl
    environment:
      - ACCOUNT_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - ACCOUNT_GRPC_SERVER_ADDRESS=0.0.0.0:${ACCOUNT_PORT}
      - ACCOUNT_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - ACCOUNT_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - ACCOUNT_METRICS_ENABLED=${METRICS_ENABLED}
      - ACCOUNT_METRICS_SERVER_ADDRESS=0.0.0.0:${ACCOUNT_METRICS_PORT}
      - ACCOUNT_MYSQL_HOSTS=databench-db:${MYSQL_PORT}
      - ACCOUNT_MYSQL_DATABASE=${MYSQL_DATABASE}
      - ACCOUNT_MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - ACCOUNT_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
      - ACCOUNT_REDIS_ADDR=databench-redis:${REDIS_PORT}
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - account

  logmanager:
    image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
    container_name: "databench-logmanager"
    command: "logmanager start -c ${DATABENCH_CONF}/logmanager.yaml"
    ports:
      - "${LOG_MANAGER_PORT}:${LOG_MANAGER_PORT}"
    depends_on:
      - hadoop
    environment:
      - LOG_MANAGER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
      - LOG_MANAGER_GRPC_SERVER_ADDRESS=0.0.0.0:${LOG_MANAGER_PORT}
      - LOG_MANAGER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
      - LOG_MANAGER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
      - LOG_MANAGER_METRICS_ENABLED=${METRICS_ENABLED}
      - LOG_MANAGER_METRICS_SERVER_ADDRESS=0.0.0.0:${LOG_MANAGER_METRICS_PORT}
      - LOG_MANAGER_HDFS_SERVER_ADDRESSES=hadoop:9000
      - LOG_MANAGER_HDFS_SERVER_USER_NAME="root"
      - LOG_MANAGER_HDFS_SERVER_BUFFER_SIZE=1024
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE}
        max-file: ${LOG_MAX_FILE}
    networks:
      databench-net:
        aliases:
          - logmanager

  enginemanager:
      image: ${IMAGE_REPO}/databench:${IMAGE_TAG}
      container_name: "databench-enginemanager"
      command: "enginemanager start -c ${DATABENCH_CONF}/enginemanager.yaml"
      ports:
        - "${ENGINE_MANAGER_PORT}:${ENGINE_MANAGER_PORT}"
      links:
        - databench-db:databench-db
      depends_on:
        - databench-db-ctrl
        - databench-etcd
        - databench-jaeger
      environment:
        - ENGINE_MANAGER_LOG_LEVEL=${DEFAULT_LOG_LEVEL}
        - ENGINE_MANAGER_GRPC_SERVER_ADDRESS=0.0.0.0:${ENGINE_MANAGER_PORT}
        - ENGIN_MANAGER_GRPC_SERVER_LOG_LEVEL=${GRPC_LOG_LEVEL}
        - ENGIN_MANAGER_GRPC_SERVER_LOG_VERBOSITY=${GRPC_LOG_VERBOSITY}
        - ENGIN_MANAGER_METRICS_ENABLED=${METRICS_ENABLED}
        - ENGINE_MANAGER_METRICS_SERVER_ADDRESS=0.0.0.0:${ENGINE_MANAGER_METRICS_PORT}
        - ENGINE_MANAGER_MYSQL_HOSTS=${MYSQL_HOST}:${MYSQL_PORT}
        - ENGINE_MANAGER_MYSQL_DATABASE=${MYSQL_DATABASE}
        - ENGINE_MANAGER_MYSQL_PASSWORD=${MYSQL_PASSWORD}
        - ENGINE_MANAGER_MYSQL_LOG_LEVEL=${MYSQL_LOG_LEVEL}
        - ENGINE_MANAGER_TRACER_SERVICE_NAME=flowmanager
        - ENGINE_MANAGER_TRACER_LOCAL_AGENT=databench-jaeger:${TRACER_PORT}
      logging:
        driver: "json-file"
        options:
          max-size: ${LOG_MAX_SIZE}
          max-file: ${LOG_MAX_FILE}
      networks:
        databench-net:
          aliases:
            - enginemanager
